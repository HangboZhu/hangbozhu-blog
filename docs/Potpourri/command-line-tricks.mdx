---
title: Linux/MacOS 中 Shell 命令行技巧分享
description: 命令行的花样玩法
tags: [vscode]
sidebar_position: 3
---

import ReferenceList from "@site/src/components/ReferenceList";
import vscode from "@site/static/img/icon/linux.png";
import AsciinemaComponent from "../../src/components/AsciinemaComponent";

生物信息吃饭的家伙，离不开 Shell 的命令行操作，其中魅力无穷。其中有一些技巧 / 配置 / 工具，可以让操作更加丝 (zhuang) 滑 (bi)。莱次够！


## Fish Shell 代替 Bash/Zsh

Bash 是 Linux 系统默认的 Shell，在初学生物信息的时候，不知道被哪篇公众号文章骗了，以为 Bash 是 Basic Shell 的简写，其实并不是，全称是 `Bourne Again Shell`，`Bourne` 是它的作者的名字。
为什么有个 again 呢，因为这哥们在之前就写过一个 Shell，叫做 Bourne Shell，所以这个是它的升级版，也是目前最常用的 Shell 版本。

后面渐渐熟悉 Linux Shell 操作了，感觉原汁原味的 Bash 无法满足我的一些效率要求，但初期我可以写一些简单的 bash function，比如：

- 我有时候要对手动装的软件的 binary 目录添加到系统环境变量 PATH:
```bash
function add_dir2path() {
    echo $PATH | grep "${PWD}:" > /dev/null
    if [$? -ne 0];then
        echo "export PATH=$PWD:\$PATH" >>$CFG/path.cfg && sbc && tail -1 $CFG/path.cfg
    else
        echo -e "\033[35m[WARNING]\033[0m --> Already in PATH" >&2
    fi
}
```
渐渐的，管理自定义的 `alias`、`functions` 也比较麻烦，有时候会忘记自己写过什么，移植到新环境也比较麻烦，要改各种路径等等。

后来接触到了 `Zsh`，一开始体验不错，UI 好看，自带功能也多，配合火热的 `oh-my-zsh` 用了一段时间，但是存在的问题就是随着 `.zshrc` 配置的冗余，zsh 越来越慢。

再到后来，接触到了 rust 写的 [starship](https://starship.rs/)，相当惊艳，之前花了大力气配置的各种 PS 变量，只需要自定义简单易读的 `toml` 配置就行了。

终于到了 23 年，把自己集群上的一些稀碎的配置、文件都整理了一些，再了解到了 [Fish Shell](https://fishshell.com/)，虽然官网的样子很复古。

Fish 的全称是 `Friendly Interactive Shell`，人如其名，最大的特点就是方便易用，很多之前 Bash/Zsh 需要配置的功能，Fish 开箱即用。

### 安装

#### MacOS 安装

不多说了，本地电脑安装最简单了，`brew` 就完事了

#### Linux 安装

如果是在有 root 权限的自己服务器上安装，挑选包管理器安装就行。

但我是在集群环境上使用的，是没有 root 权限的，所以选择源码安装：

```shell
# 下载源码
wget https://github.com/fish-shell/fish-shell/releases/download/3.6.1/fish-3.6.1.tar.xz
# 解压
tar -xvf fish-3.6.1.tar.xz
# 进入目录
cd fish-3.6.1
# 配置
cmake . ## cmake 版本要求详见 README.rst
# 编译
make -j8 ## 加加速
# 安装
make install ## 一般而言你没权限装到系统目录，所以需要指定安装目录
```
### 配置

#### 设置为默认 Shell

- 有 root 权限的服务器，可以直接 `chsh -s /usr/local/bin/fish`，然后重新登录即可
- 没有 root 权限的服务器，比如我的集群，我在 `~/.bash_profile` 中添加 `exec /your/path/to/fish`，然后重新登录即可，
这样相当于每次登录都会执行 `fish`，就相当于默认了

#### 配置主题

我比较喜欢干净简洁的 `pure` 主题： https://github.com/pure-fish/pure

### 特点

#### 执行结果颜色区分

执行结果是否成功，会有不同的颜色区分，比如：

<AsciinemaComponent src="https://asciinema.org/a/588641.cast" rows={10} idleTimeLimit={3} preload={true} />



#### 路径是否存在提醒

如果命令行中输入的路径存在，会有下划线提示，否则没有，可以避免输入错误路径，如图所示：

![fish-2](https://raw.githubusercontent.com/wjwei-handsome/wwjPic/main/img/20230531165841.png)

#### 自动建议/补全

Fish 会自动根据你的输入，给出建议，比如：

- 命令建议，比如 `git` 命令，输入 `gi`，会出现 `git push` 命令的建议，按下 <kbd>Tab</kbd> 键，就会自动补全：

![fish-3](https://raw.githubusercontent.com/wjwei-handsome/wwjPic/main/img/20230531170114.png)

:::note

它的建议主要是根据你的history来的，比如我最近执行 `git push`比较多，就会给出这个建议。

:::

- 参数建议，有些命令的参数，对于非英语母语的用户来说，有些记不住，比如`grep`的`--files-without-match`参数，有时候无法写出完整的，这时候输入 `grep --file`，按下 <kbd>Tab</kbd> 键，就会给出参数的含义：

![fish-4](https://raw.githubusercontent.com/wjwei-handsome/wwjPic/main/img/20230531170652.png)

:::note

不仅参数，一些软件的子命令也可以给出补全和含义，只要配置好自己的completions即可

:::


在安装fish时候，会自动安装一些Linux自带命令的completions，具体目录参见[这里官方文档](https://fishshell.com/docs/current/completions.html),

比如我经常记不住的sort的参数：

![fish-sort](https://raw.githubusercontent.com/wjwei-handsome/wwjPic/main/img/20230531171119.png)

一些友好的第三方软件在安装时候，也会自动配置completions，或者提供生成completions的命令，比如我常用的`csvtk`和`seqkit`

```shell
seqkit genautocomplete --shell fish --file ~/.config/fish/completions/seqkit.fish
```

```shell
csvtk genautocomplete --shell fish --file ~/.config/fish/completions/csvtk.fish
```
生成补全建议后效果：

![fish-seqkit](https://raw.githubusercontent.com/wjwei-handsome/wwjPic/main/img/20230531171422.png)

如果没有这个，我忘了命令用法，只能去网上搜，所以这大大提示了效率

- /其他补全

还包括但不限于：
1. 路径建议补全
2. git分支补全
3. 命令历史补全
4. 环境变量补全
5. ssh hosts补全
6. ...

#### 实用的内置函数

- `string`：字符串处理函数，比如 `string match`，`string replace`，`string split`，`string join`，`string sub`等
- `math`：数学函数，这个对我而言比较实用，我在做一些实时统计的时候，要做一些简单的运算，比如：我要统计日志目录中运行成功的数量，并除以总任务的数量，可以这样：
```shell
math (rg 'Successfully completed' -tlog -l|wc -l)/(wc -l ../sample.list |cut -f1 -d' ')
```
语法简洁明了
- `fish_add_path`: 添加环境变量，比如 `fish_add_path /my/new_software/dir/bin`，这样就可以直接执行 `/my/new_software/dir/bin` 下的命令了
- 其他的详见[官方文档](https://fishshell.com/docs/current/commands.html)

#### 不一样的语法？

Fish 的语法和 Bash 有些不同，其中优劣，各有千秋，都是工具，顺手就行。个人觉得Fish的语法更合我胃口，比如：





## 参考资料

<ReferenceList
    data={[
        {
            title: "Fish 官方文档 ",
            link: "https://marketplace.visualstudio.com",
            src: vscode,
        },
    ]}
/>
